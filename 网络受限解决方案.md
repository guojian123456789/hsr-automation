# 🌐 网络受限环境 - Android APK 构建解决方案

## 🚨 当前问题

**症状**：
```
✅ Docker 已安装并运行
✅ 镜像加速器已配置
❌ 无法连接 Docker Hub
❌ 无法连接国内镜像源
```

**原因**：网络环境受限（防火墙/DNS/代理限制）

---

## 🎯 解决方案对比

| 方案 | 难度 | 时间 | 网络要求 | 推荐度 |
|------|------|------|----------|--------|
| **方案A: GitHub Actions** | ⭐ | 10分钟 | 低 | ⭐⭐⭐⭐⭐ |
| **方案B: WSL 构建** | ⭐⭐ | 30分钟 | 中 | ⭐⭐⭐⭐ |
| **方案C: 获取预构建镜像** | ⭐ | 5分钟 | 低 | ⭐⭐⭐⭐ |
| **方案D: VPN/代理** | ⭐⭐⭐ | 变化大 | 高 | ⭐⭐ |

---

## 🚀 方案A: GitHub Actions 云端构建（推荐）

**优势**：
- ✅ 完全在云端构建，不受本地网络限制
- ✅ 免费（GitHub Actions 免费额度充足）
- ✅ 自动化，每次推送代码自动构建
- ✅ 可下载构建好的 APK

### 实施步骤

#### 1. 创建 GitHub 仓库

```bash
# 1. 初始化 git（如果还没有）
git init

# 2. 添加所有文件
git add .

# 3. 提交
git commit -m "Initial commit - HSR Automation"

# 4. 在 GitHub 创建新仓库
# 访问: https://github.com/new

# 5. 关联远程仓库
git remote add origin https://github.com/你的用户名/hsr-automation.git

# 6. 推送
git push -u origin main
```

#### 2. 创建 GitHub Actions 工作流

创建文件：`.github/workflows/build-android.yml`

```yaml
name: Build Android APK

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # 允许手动触发

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y git zip unzip openjdk-17-jdk autoconf libtool pkg-config zlib1g-dev libncurses5-dev libncursesw5-dev libtinfo5 cmake libffi-dev libssl-dev
        pip install --upgrade pip
        pip install buildozer cython==0.29.33
    
    - name: Build APK with Buildozer
      run: |
        buildozer android debug
    
    - name: Upload APK
      uses: actions/upload-artifact@v3
      with:
        name: hsr-automation-apk
        path: bin/*.apk
```

#### 3. 推送并获取 APK

```bash
# 1. 添加工作流文件
git add .github/workflows/build-android.yml
git commit -m "Add GitHub Actions build workflow"
git push

# 2. 查看构建进度
# 访问: https://github.com/你的用户名/hsr-automation/actions

# 3. 构建完成后下载 APK
# 在 Actions 页面点击最新的构建 → Artifacts → 下载
```

**时间**：首次构建约 15-30 分钟

---

## 🐧 方案B: WSL (Windows Subsystem for Linux) 构建

**优势**：
- ✅ 本地构建，可离线
- ✅ 比 Docker 网络要求低
- ✅ Windows 原生支持

### 实施步骤

#### 1. 安装 WSL

```powershell
# 以管理员身份打开 PowerShell

# 安装 WSL (Ubuntu)
wsl --install

# 重启电脑
```

#### 2. 配置 WSL 环境

```bash
# 进入 WSL
wsl

# 更新包管理器
sudo apt update && sudo apt upgrade -y

# 安装依赖
sudo apt install -y git zip unzip openjdk-17-jdk python3-pip \
    autoconf libtool pkg-config zlib1g-dev \
    libncurses5-dev libncursesw5-dev libtinfo5 \
    cmake libffi-dev libssl-dev

# 安装 Buildozer
pip3 install --upgrade pip
pip3 install buildozer cython==0.29.33
```

#### 3. 复制项目到 WSL

```bash
# 在 WSL 中访问 Windows 文件
cd /mnt/d/插件

# 或复制项目到 WSL 主目录
cp -r /mnt/d/插件 ~/hsr-automation
cd ~/hsr-automation
```

#### 4. 构建 APK

```bash
# 清理旧构建（如果有）
buildozer android clean

# 开始构建
buildozer android debug

# APK 位置：bin/hsrautomation-1.0-arm64-v8a-debug.apk
```

#### 5. 复制 APK 到 Windows

```bash
# 复制到 Windows
cp bin/*.apk /mnt/d/插件/
```

**时间**：首次构建约 30-60 分钟

---

## 📦 方案C: 获取预构建 Docker 镜像

**如果有其他电脑或朋友可以下载镜像**：

### 在有网络的电脑上：

```bash
# 1. 下载镜像
docker pull ubuntu:22.04

# 2. 导出镜像
docker save ubuntu:22.04 -o ubuntu-22.04.tar

# 3. 压缩（可选）
gzip ubuntu-22.04.tar
# 得到：ubuntu-22.04.tar.gz (约 250MB)
```

### 在当前电脑上：

```powershell
# 1. 获取镜像文件（U盘/网盘等）

# 2. 导入镜像
docker load -i ubuntu-22.04.tar

# 或解压后导入
# gzip -d ubuntu-22.04.tar.gz
# docker load -i ubuntu-22.04.tar

# 3. 验证
docker images | findstr ubuntu

# 4. 重新构建
.\build_android_auto.bat debug
```

---

## 🔧 方案D: 配置 VPN/代理

### Docker Desktop 代理配置

1. **打开 Docker Desktop Settings**

2. **Resources → Proxies**

3. **配置代理**：
   ```
   Manual proxy configuration
   
   Web Server (HTTP): http://127.0.0.1:端口号
   Secure Web Server (HTTPS): http://127.0.0.1:端口号
   
   ☑ Use proxy for DNS queries
   ```

4. **Apply & Restart**

### 系统代理配置

```powershell
# 设置环境变量（临时）
$env:HTTP_PROXY = "http://127.0.0.1:端口号"
$env:HTTPS_PROXY = "http://127.0.0.1:端口号"

# 重启 Docker Desktop
Restart-Service docker
```

---

## 📊 方案选择建议

### 你的情况：网络严重受限

```
推荐顺序：
1. GitHub Actions (最简单，完全云端)
2. WSL 构建 (本地控制，网络要求较低)
3. 获取预构建镜像 (需要外部资源)
4. VPN/代理 (如果有可用的代理)
```

### 快速决策树

```
你有 GitHub 账号？
├─ 是 → 使用 GitHub Actions ⭐⭐⭐⭐⭐
└─ 否 → 你愿意安装 WSL？
    ├─ 是 → 使用 WSL 构建 ⭐⭐⭐⭐
    └─ 否 → 你有其他能上网的电脑？
        ├─ 是 → 获取预构建镜像 ⭐⭐⭐
        └─ 否 → 尝试配置代理 ⭐⭐
```

---

## 🎯 立即行动方案

### 最快方案（推荐）：GitHub Actions

**步骤**（10分钟完成）：

1. **创建 GitHub 账号**（如果没有）
   - https://github.com/signup

2. **创建新仓库**
   - https://github.com/new
   - 仓库名：`hsr-automation`
   - Public/Private 都可以

3. **上传代码**：
   ```bash
   # 在项目目录
   git init
   git add .
   git commit -m "Initial commit"
   git remote add origin https://github.com/你的用户名/hsr-automation.git
   git push -u origin main
   ```

4. **创建工作流文件**：
   - 创建 `.github/workflows/build-android.yml`
   - 复制上面的 YAML 配置
   - 提交并推送

5. **等待构建**（15-30分钟）：
   - 访问：https://github.com/你的用户名/hsr-automation/actions
   - 查看构建进度

6. **下载 APK**：
   - 构建完成后，点击 Artifacts
   - 下载 `hsr-automation-apk.zip`

---

## ⚡ 临时替代方案

### 使用在线 Python 环境

**Google Colab**（免费）：

```python
# 在 Colab notebook 中运行

# 1. 安装依赖
!apt-get update
!apt-get install -y git zip unzip openjdk-17-jdk
!pip install buildozer cython==0.29.33

# 2. 克隆你的项目
!git clone https://github.com/你的用户名/hsr-automation.git
%cd hsr-automation

# 3. 构建
!buildozer android debug

# 4. 下载 APK
from google.colab import files
!zip -r apk.zip bin/*.apk
files.download('apk.zip')
```

---

## ❓ 常见问题

### Q1: 为什么 Docker 镜像源也连不上？

**A**: 可能是：
- DNS 被限制
- 防火墙拦截 HTTPS
- 企业网络策略

**解决**: 使用云端构建（GitHub Actions）

### Q2: WSL 下载也很慢怎么办？

**A**: 配置 WSL 使用国内源：

```bash
# Ubuntu 换源
sudo sed -i 's@archive.ubuntu.com@mirrors.aliyun.com@g' /etc/apt/sources.list
sudo apt update
```

### Q3: GitHub Actions 免费额度够用吗？

**A**: 
- 公开仓库：无限制
- 私有仓库：每月 2000 分钟
- 单次构建约 15-30 分钟
- **完全够用！**

---

## 🎉 成功标准

构建成功后，你会得到：

```
bin/hsrautomation-1.0-arm64-v8a-debug.apk
文件大小：约 30-50MB
```

安装到手机：

```bash
adb install bin/hsrautomation-1.0-arm64-v8a-debug.apk
```

---

## 📞 下一步

**你想使用哪个方案？**

A. **GitHub Actions**（推荐，最简单）
B. **WSL 构建**（本地控制）
C. **获取预构建镜像**（需要帮助）
D. **其他方案**

告诉我你的选择，我会提供详细的分步指导！

