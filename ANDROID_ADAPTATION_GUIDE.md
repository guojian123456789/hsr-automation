# ğŸ¤– Androidå¹³å°é€‚é…å®Œæ•´æŒ‡å—

## ğŸ“± å·²å®ç°çš„AndroidåŠŸèƒ½

### âœ… å±å¹•æˆªå›¾ï¼ˆMediaProjection APIï¼‰

**æ–‡ä»¶**: `android_screen_capture.py`

**åŠŸèƒ½**:
- ä½¿ç”¨MediaProjection APIå®ç°æ— Rootå±å¹•æˆªå›¾
- è¿”å›ä¸OpenCVå…¼å®¹çš„BGRæ ¼å¼å›¾åƒ
- æ”¯æŒå®æ—¶æˆªå›¾

**ä½¿ç”¨æ–¹æ³•**:
```python
from android_screen_capture import AndroidScreenCapture

# åˆå§‹åŒ–
capture = AndroidScreenCapture()

# è¯·æ±‚æƒé™ï¼ˆä¼šå¼¹å‡ºç³»ç»Ÿæˆæƒçª—å£ï¼‰
capture.request_permission()

# åœ¨æƒé™æˆäºˆåå¼€å§‹æˆªå›¾
if capture.is_ready():
    screenshot = capture.capture_screen()
    # screenshotæ˜¯numpy arrayï¼ŒBGRæ ¼å¼
```

**æƒé™è¦æ±‚**:
- ç”¨æˆ·éœ€è¦åœ¨å¼¹å‡ºçš„ç³»ç»Ÿçª—å£ä¸­ç‚¹å‡»"ç«‹å³å¼€å§‹"æˆäºˆæˆªå±æƒé™
- æ­¤æƒé™ä»…åœ¨åº”ç”¨è¿è¡ŒæœŸé—´æœ‰æ•ˆ

---

### âœ… æ¨¡æ‹Ÿç‚¹å‡»ï¼ˆAccessibility Serviceï¼‰

**æ–‡ä»¶**: 
- Pythonå±‚: `android_accessibility_service.py`
- Javaå±‚: `service/HSRAccessibilityService.java`
- é…ç½®: `service/accessibility_service_config.xml`

**åŠŸèƒ½**:
- ä½¿ç”¨AccessibilityServiceå®ç°æ— Rootæ¨¡æ‹Ÿç‚¹å‡»
- æ”¯æŒç‚¹å‡»å’Œæ»‘åŠ¨æ‰‹åŠ¿
- é€šè¿‡å¹¿æ’­æœºåˆ¶ä¸Pythoné€šä¿¡

**ä½¿ç”¨æ–¹æ³•**:
```python
from android_accessibility_service import AndroidAccessibilityService

# åˆå§‹åŒ–
accessibility = AndroidAccessibilityService()

# æ£€æŸ¥æœåŠ¡æ˜¯å¦å·²å¯ç”¨
if not accessibility.check_service_enabled():
    # æ‰“å¼€è®¾ç½®é¡µé¢è®©ç”¨æˆ·æ‰‹åŠ¨å¯ç”¨
    accessibility.request_service_permission()

# æ‰§è¡Œç‚¹å‡»
accessibility.click(x=100, y=200, duration=100)

# æ‰§è¡Œæ»‘åŠ¨
accessibility.swipe(
    start_x=100, start_y=500,
    end_x=100, end_y=200,
    duration=300
)
```

**æƒé™è¦æ±‚**:
- ç”¨æˆ·éœ€è¦åœ¨è®¾ç½®ä¸­æ‰‹åŠ¨å¯ç”¨æ— éšœç¢æœåŠ¡
- è·¯å¾„: è®¾ç½® â†’ è¾…åŠ©åŠŸèƒ½ â†’ å·²å®‰è£…çš„æœåŠ¡ â†’ HSR Automation â†’ å¼€å¯

---

## ğŸ”§ é›†æˆæ–¹å¼

### 1. image_processor.py è‡ªåŠ¨é€‚é…

```python
def capture_screen(self):
    """è‡ªåŠ¨æ ¹æ®å¹³å°é€‰æ‹©æˆªå›¾æ–¹å¼"""
    if self.platform == 'android':
        return self.capture_android_screen()  # ä½¿ç”¨MediaProjection
    else:
        return self.capture_desktop_screen()  # ä½¿ç”¨PIL
```

### 2. game_controller.py è‡ªåŠ¨é€‚é…

```python
def click_position(self, position):
    """è‡ªåŠ¨æ ¹æ®å¹³å°é€‰æ‹©ç‚¹å‡»æ–¹å¼"""
    x, y = position
    
    if self.platform == 'android':
        return self.android_click(x, y)  # ä½¿ç”¨AccessibilityService
    else:
        return self.desktop_click(x, y)  # ä½¿ç”¨PyAutoGUI/Win32API
```

---

## ğŸ“‹ æ„å»ºé…ç½®

### buildozer.spec å…³é”®é…ç½®

```ini
# æ·»åŠ pyjniusä¾èµ–ï¼ˆç”¨äºPythonè°ƒç”¨Javaï¼‰
requirements = python3,kivy,numpy,pillow,opencv,pyyaml,pyjnius

# åŒ…å«JavaæœåŠ¡æ–‡ä»¶
source.include_patterns = service/*.java,service/*.xml

# æ³¨å†ŒAccessibilityService
android.services = HSRAccessibilityService:service/HSRAccessibilityService.java

# æ·»åŠ æœåŠ¡é…ç½®å…ƒæ•°æ®
android.meta_data = com.hsr.automation.accessibility_service=@xml/accessibility_service_config

# å¿…éœ€æƒé™
android.permissions = SYSTEM_ALERT_WINDOW,WRITE_EXTERNAL_STORAGE,READ_EXTERNAL_STORAGE,INTERNET,ACCESS_NETWORK_STATE,WAKE_LOCK,FOREGROUND_SERVICE
```

---

## ğŸš€ ç”¨æˆ·ä½¿ç”¨æµç¨‹

### é¦–æ¬¡è¿è¡Œè®¾ç½®

1. **å®‰è£…APK**
   ```bash
   adb install bin/hsrautomation-1.0-arm64-v8a-debug.apk
   ```

2. **å¯åŠ¨åº”ç”¨**
   - æ‰“å¼€HSR Automation

3. **æˆäºˆå±å¹•å½•åˆ¶æƒé™**
   - åº”ç”¨ä¼šè‡ªåŠ¨è¯·æ±‚æˆªå±æƒé™
   - åœ¨å¼¹å‡ºçª—å£ä¸­ç‚¹å‡»"ç«‹å³å¼€å§‹"

4. **å¯ç”¨æ— éšœç¢æœåŠ¡**
   - åº”ç”¨ä¼šå¼•å¯¼åˆ°è®¾ç½®é¡µé¢
   - è·¯å¾„: è®¾ç½® â†’ è¾…åŠ©åŠŸèƒ½ â†’ å·²å®‰è£…çš„æœåŠ¡
   - æ‰¾åˆ°"HSR Automation"å¹¶å¼€å¯

5. **å¼€å§‹ä½¿ç”¨**
   - è¿”å›åº”ç”¨
   - å‹¾é€‰éœ€è¦çš„åŠŸèƒ½
   - ç‚¹å‡»STARTå¼€å§‹è‡ªåŠ¨åŒ–

---

## ğŸ¯ æŠ€æœ¯æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Pythonå±‚ (Kivy)                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  main.py (UI)                     â”‚  â”‚
â”‚  â”‚  automation_engine.py (é€»è¾‘)      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚           â†“                â†“             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ image_      â”‚    â”‚ game_       â”‚     â”‚
â”‚  â”‚ processor   â”‚    â”‚ controller  â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚         â”‚                  â”‚             â”‚
â”‚         â†“                  â†“             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ android_    â”‚    â”‚ android_    â”‚     â”‚
â”‚  â”‚ screen_     â”‚    â”‚ accessi-    â”‚     â”‚
â”‚  â”‚ capture.py  â”‚    â”‚ bility_     â”‚     â”‚
â”‚  â”‚             â”‚    â”‚ service.py  â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚         â”‚                  â”‚             â”‚
â”‚         â†“                  â†“             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ jnius       â”‚    â”‚ jnius       â”‚     â”‚
â”‚  â”‚ (Python-    â”‚    â”‚ (Broadcast) â”‚     â”‚
â”‚  â”‚  Javaæ¡¥æ¥)  â”‚    â”‚             â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                  â”‚
          â†“                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Java/Androidå±‚                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ Media-      â”‚    â”‚ HSR         â”‚     â”‚
â”‚  â”‚ Projection  â”‚    â”‚ Accessi-    â”‚     â”‚
â”‚  â”‚ Manager     â”‚    â”‚ bility      â”‚     â”‚
â”‚  â”‚             â”‚    â”‚ Service     â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚         â”‚                  â”‚             â”‚
â”‚         â†“                  â†“             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ Screen      â”‚    â”‚ Gesture     â”‚     â”‚
â”‚  â”‚ Capture     â”‚    â”‚ Dispatch    â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. æƒé™è¯´æ˜

**å±å¹•å½•åˆ¶æƒé™**:
- è¿è¡Œæ—¶æƒé™ï¼Œæ¯æ¬¡å¯åŠ¨åº”ç”¨éƒ½éœ€è¦é‡æ–°æˆäºˆ
- ä»…ç”¨äºæˆªå–æ¸¸æˆç”»é¢è¿›è¡Œè¯†åˆ«
- ä¸ä¼šå½•åˆ¶æˆ–ä¿å­˜è§†é¢‘

**æ— éšœç¢æœåŠ¡æƒé™**:
- ç³»ç»Ÿçº§æƒé™ï¼Œéœ€è¦ç”¨æˆ·æ‰‹åŠ¨åœ¨è®¾ç½®ä¸­å¼€å¯
- ä¸€æ¬¡å¼€å¯åæŒç»­æœ‰æ•ˆ
- ä»…ç”¨äºæ¨¡æ‹Ÿç‚¹å‡»æ¸¸æˆç•Œé¢
- ä¸ä¼šè®¿é—®å…¶ä»–åº”ç”¨çš„æ•°æ®

### 2. æ€§èƒ½è€ƒè™‘

**æˆªå›¾æ€§èƒ½**:
- MediaProjectionæˆªå›¾é€Ÿåº¦: ~50-100ms/å¼ 
- å»ºè®®é—´éš”è‡³å°‘200mså†æ¬¡æˆªå›¾
- é¿å…è¿‡äºé¢‘ç¹çš„æˆªå›¾é€ æˆæ€§èƒ½é—®é¢˜

**ç‚¹å‡»å»¶è¿Ÿ**:
- AccessibilityServiceç‚¹å‡»å»¶è¿Ÿ: ~50-200ms
- æ¯”ç›´æ¥è§¦æ‘¸æ…¢ï¼Œä½†è¶³å¤Ÿç”¨äºæ¸¸æˆè‡ªåŠ¨åŒ–
- å»ºè®®ç‚¹å‡»åç­‰å¾…è‡³å°‘100ms

### 3. å…¼å®¹æ€§

**Androidç‰ˆæœ¬è¦æ±‚**:
- æœ€ä½: Android 5.0 (API 21)
- æ¨è: Android 7.0+ (API 24+)
- MediaProjection: API 21+
- AccessibilityServiceæ‰‹åŠ¿: API 24+

**å·²æµ‹è¯•è®¾å¤‡**:
- éœ€è¦åœ¨å®é™…è®¾å¤‡ä¸Šæµ‹è¯•
- ä¸åŒå‚å•†ROMå¯èƒ½æœ‰å·®å¼‚
- éƒ¨åˆ†MIUI/EMUIå¯èƒ½éœ€è¦é¢å¤–è®¾ç½®

---

## ğŸ› æ•…éšœæ’é™¤

### é—®é¢˜1: å±å¹•æˆªå›¾å¤±è´¥

**ç—‡çŠ¶**: æˆªå›¾è¿”å›Noneæˆ–é»‘å±

**è§£å†³æ–¹æ³•**:
1. æ£€æŸ¥æ˜¯å¦æˆäºˆäº†å±å¹•å½•åˆ¶æƒé™
2. é‡å¯åº”ç”¨é‡æ–°è¯·æ±‚æƒé™
3. æ£€æŸ¥æ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯

### é—®é¢˜2: ç‚¹å‡»æ— ååº”

**ç—‡çŠ¶**: å‘é€ç‚¹å‡»æŒ‡ä»¤ä½†æ¸¸æˆæ— å“åº”

**è§£å†³æ–¹æ³•**:
1. ç¡®è®¤æ— éšœç¢æœåŠ¡å·²å¯ç”¨
2. æ£€æŸ¥æœåŠ¡æ˜¯å¦åœ¨è¿è¡Œ: `adb shell dumpsys accessibility`
3. é‡å¯æ— éšœç¢æœåŠ¡
4. æ£€æŸ¥æ¸¸æˆæ˜¯å¦åœ¨å‰å°

### é—®é¢˜3: æ„å»ºå¤±è´¥

**ç—‡çŠ¶**: buildozerç¼–è¯‘JavaæœåŠ¡å¤±è´¥

**è§£å†³æ–¹æ³•**:
1. ç¡®ä¿serviceç›®å½•ç»“æ„æ­£ç¡®
2. æ£€æŸ¥Javaè¯­æ³•é”™è¯¯
3. æŸ¥çœ‹æ„å»ºæ—¥å¿—: `.buildozer/android/platform/build-*/logs/`

### é—®é¢˜4: æƒé™è¯·æ±‚æ— å“åº”

**ç—‡çŠ¶**: ç‚¹å‡»æƒé™æŒ‰é’®åæ— ååº”

**è§£å†³æ–¹æ³•**:
1. æ£€æŸ¥Intentæ˜¯å¦æ­£ç¡®å‘é€
2. ä½¿ç”¨adbæŸ¥çœ‹ç³»ç»Ÿæ—¥å¿—: `adb logcat`
3. å°è¯•æ‰‹åŠ¨è¿›å…¥è®¾ç½®é¡µé¢

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [MediaProjectionå®˜æ–¹æ–‡æ¡£](https://developer.android.com/reference/android/media/projection/MediaProjection)
- [AccessibilityServiceå®˜æ–¹æ–‡æ¡£](https://developer.android.com/reference/android/accessibilityservice/AccessibilityService)
- [Pyjniusæ–‡æ¡£](https://pyjnius.readthedocs.io/)
- [Buildozeræ–‡æ¡£](https://buildozer.readthedocs.io/)

---

## âœ… å®Œæˆæ£€æŸ¥æ¸…å•

æ„å»ºå‰ç¡®è®¤:

- [x] `android_screen_capture.py` - æˆªå›¾æ¨¡å—å·²åˆ›å»º
- [x] `android_accessibility_service.py` - ç‚¹å‡»æ¨¡å—å·²åˆ›å»º  
- [x] `service/HSRAccessibilityService.java` - JavaæœåŠ¡å·²åˆ›å»º
- [x] `service/accessibility_service_config.xml` - é…ç½®æ–‡ä»¶å·²åˆ›å»º
- [x] `image_processor.py` - å·²é›†æˆAndroidæˆªå›¾
- [x] `game_controller.py` - å·²é›†æˆAndroidç‚¹å‡»
- [x] `buildozer.spec` - å·²æ·»åŠ å¿…è¦é…ç½®
- [ ] åœ¨çœŸæœºä¸Šæµ‹è¯•æˆªå›¾åŠŸèƒ½
- [ ] åœ¨çœŸæœºä¸Šæµ‹è¯•ç‚¹å‡»åŠŸèƒ½
- [ ] æµ‹è¯•æƒé™è¯·æ±‚æµç¨‹

---

**ç‰ˆæœ¬**: 1.0  
**æ›´æ–°æ—¥æœŸ**: 2025-10-06  
**çŠ¶æ€**: âœ… Androidé€‚é…å·²å®Œæˆ




