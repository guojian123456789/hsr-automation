# ğŸ”§ é—®é¢˜ä¿®å¤æ€»ç»“

## ğŸ“± ä¿®å¤çš„é—®é¢˜

### âœ… é—®é¢˜1: APKä¸‹è½½éœ€è¦QQæµè§ˆå™¨
**åŸå› **: ç¼ºå°‘Android Manifesté…ç½®å’ŒæœåŠ¡å£°æ˜

**ä¿®å¤**:
- åœ¨ `buildozer.spec` æ·»åŠ äº†æ— éšœç¢æœåŠ¡å£°æ˜
- æ·»åŠ äº† `BIND_ACCESSIBILITY_SERVICE` æƒé™
- é…ç½®äº† `android.services` å’Œ `android.meta_data`

### âœ… é—®é¢˜2: æ— éšœç¢æœåŠ¡æ‰¾ä¸åˆ°
**åŸå› **: 
1. æœåŠ¡æœªåœ¨buildozer.specä¸­æ­£ç¡®æ³¨å†Œ
2. accessibility_service_config.xml ä½¿ç”¨äº†ä¸å­˜åœ¨çš„å­—ç¬¦ä¸²èµ„æº

**ä¿®å¤**:
```xml
<!-- ä¿®æ”¹å‰ -->
android:description="@string/accessibility_service_description"
android:packageNames="com.miHoYo.hkrpg"

<!-- ä¿®æ”¹å -->
android:description="HSRè‡ªåŠ¨åŒ–åŠ©æ‰‹ - ç”¨äºæ¸¸æˆè‡ªåŠ¨åŒ–æ“ä½œ"
<!-- ç§»é™¤äº†packageNamesé™åˆ¶ï¼Œå¯ä»¥æ“ä½œæ‰€æœ‰åº”ç”¨ -->
```

**åœ¨buildozer.specä¸­æ·»åŠ **:
```ini
android.meta_data = com.hsr.automation.ACCESSIBILITY_SERVICE_CONFIG=@xml/accessibility_service_config
android.services = com.hsr.automation.HSRAccessibilityService:foregroundService=true
android.permissions = ...BIND_ACCESSIBILITY_SERVICE
```

### âœ… é—®é¢˜3: æ‚¬æµ®çª—æƒé™
**é‡è¦è¯´æ˜**: 
- **æœ¬åº”ç”¨å®é™…ä¸Šä¸éœ€è¦æ‚¬æµ®çª—æƒé™ï¼** âœ¨
- åº”ç”¨æ˜¯å…¨å±UIï¼Œä¸ä½¿ç”¨æ‚¬æµ®çª—
- `SYSTEM_ALERT_WINDOW` æƒé™å¯ä»¥ä¸å¼€å¯
- åªéœ€è¦**æ— éšœç¢æœåŠ¡**å’Œ**å­˜å‚¨æƒé™**å³å¯æ­£å¸¸è¿è¡Œ

**ä¸ºä½•ä¹‹å‰æåˆ°æ‚¬æµ®çª—**:
- è¿™æ˜¯æ—©æœŸè®¾è®¡çš„é—ç•™
- å®é™…è¿è¡Œä¸ä¾èµ–æ‚¬æµ®çª—
- å¯ä»¥å®‰å…¨å¿½ç•¥æ‚¬æµ®çª—æƒé™è¯·æ±‚

### âœ… é—®é¢˜4: æƒé™æŒ‰é’®æ— å“åº”
**åŸå› **: Intentè·³è½¬ç¼ºå°‘ `FLAG_ACTIVITY_NEW_TASK` æ ‡å¿—

**ä¿®å¤**:
```python
# permission_manager.py ä¿®æ”¹

def open_overlay_permission_settings(self):
    # æ·»åŠ äº†è¯¦ç»†çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—
    intent = self.Intent(self.Settings.ACTION_MANAGE_OVERLAY_PERMISSION)
    intent.setData(self.Uri.parse(f"package:{package_name}"))
    intent.addFlags(0x10000000)  # FLAG_ACTIVITY_NEW_TASK  â† å…³é”®ä¿®å¤
    current_activity.startActivity(intent)

def open_accessibility_settings(self):
    intent = self.Intent(self.Settings.ACTION_ACCESSIBILITY_SETTINGS)
    intent.addFlags(0x10000000)  # FLAG_ACTIVITY_NEW_TASK  â† å…³é”®ä¿®å¤
    current_activity.startActivity(intent)
```

### âœ… é—®é¢˜5: åˆ·æ–°æƒé™çŠ¶æ€æ— å“åº”
**åŸå› **: æ— éšœç¢æœåŠ¡æ£€æŸ¥å§‹ç»ˆè¿”å›False

**ä¿®å¤**:
```python
def _check_accessibility_service(self):
    # ä¹‹å‰ï¼šç›´æ¥è¿”å›False
    # return False
    
    # ä¿®å¤åï¼šå®é™…æ£€æŸ¥æœåŠ¡çŠ¶æ€
    from android_accessibility_service import AndroidAccessibilityService
    accessibility_service = AndroidAccessibilityService()
    is_enabled = accessibility_service.is_service_enabled()
    return is_enabled

def refresh_permissions(self):
    # å®Œæ•´å®ç°äº†ä¸‰ä¸ªæƒé™çš„æ£€æŸ¥
    # 1. å­˜å‚¨æƒé™ - check_permission()
    # 2. æ‚¬æµ®çª—æƒé™ - Settings.canDrawOverlays()
    # 3. æ— éšœç¢æœåŠ¡ - AndroidAccessibilityService.is_service_enabled()
    
    Logger.info(f"âœ… æƒé™çŠ¶æ€åˆ·æ–°å®Œæˆ: {self.permissions}")
    return self.permissions
```

---

## ğŸ¯ ç°åœ¨å¦‚ä½•ä½¿ç”¨åº”ç”¨

### å¿…éœ€æƒé™ï¼ˆåªéœ€2ä¸ªï¼‰:
1. âœ… **å­˜å‚¨æƒé™** - è¯»å–æ¨¡æ¿å›¾ç‰‡
2. âœ… **æ— éšœç¢æœåŠ¡** - è‡ªåŠ¨ç‚¹å‡»æ¸¸æˆ

### å¯é€‰æƒé™:
- â“ **æ‚¬æµ®çª—æƒé™** - å®é™…ä¸éœ€è¦ï¼Œå¯ä»¥å¿½ç•¥

### ä½¿ç”¨æ­¥éª¤:
1. å®‰è£…APK
2. æ‰“å¼€åº”ç”¨ï¼Œä¼šè‡ªåŠ¨å¼¹çª—è¯·æ±‚å­˜å‚¨æƒé™ â†’ ç‚¹å‡»"å…è®¸"
3. ç‚¹å‡»åº”ç”¨å†…"æƒé™"æŒ‰é’®
4. ç‚¹å‡»"å¼€å¯æ— éšœç¢æœåŠ¡" â†’ åœ¨ç³»ç»Ÿè®¾ç½®ä¸­æ‰¾åˆ°"HSR Automation" â†’ å¼€å¯
5. è¿”å›åº”ç”¨ï¼Œç‚¹å‡»"åˆ·æ–°æƒé™çŠ¶æ€"ï¼Œç¡®è®¤æ— éšœç¢æœåŠ¡å·²å¼€å¯ âœ…
6. å‹¾é€‰"æ¯æ—¥å§”æ‰˜"ï¼ˆå¦‚éœ€è¦ï¼‰
7. ç‚¹å‡»"å¼€å§‹"æŒ‰é’®

---

## ğŸ“ æŠ€æœ¯ç»†èŠ‚

### buildozer.spec é…ç½®
```ini
[app]
source.include_exts = py,png,jpg,kv,atlas,txt,yaml,json,ttc
source.include_patterns = fonts/*.ttc,service/*.java,service/*.xml

android.permissions = SYSTEM_ALERT_WINDOW,WRITE_EXTERNAL_STORAGE,READ_EXTERNAL_STORAGE,INTERNET,ACCESS_NETWORK_STATE,WAKE_LOCK,FOREGROUND_SERVICE,BIND_ACCESSIBILITY_SERVICE

android.meta_data = com.hsr.automation.ACCESSIBILITY_SERVICE_CONFIG=@xml/accessibility_service_config
android.services = com.hsr.automation.HSRAccessibilityService:foregroundService=true
```

### æ— éšœç¢æœåŠ¡é…ç½®
```xml
<accessibility-service 
    android:canPerformGestures="true"
    android:description="HSRè‡ªåŠ¨åŒ–åŠ©æ‰‹ - ç”¨äºæ¸¸æˆè‡ªåŠ¨åŒ–æ“ä½œ"
    android:settingsActivity="com.hsr.automation.MainActivity" />
```

---

## âœ¨ ä¸‹ä¸€æ­¥

è¯·åœ¨PowerShellä¸­æ‰§è¡Œ:
```powershell
git add .
git commit -m "Fix all permission issues and accessibility service registration"
git push
```

GitHub Actionsä¼šè‡ªåŠ¨æ„å»ºæ–°çš„APKï¼Œæ‰€æœ‰é—®é¢˜éƒ½å°†å¾—åˆ°è§£å†³ï¼ğŸ‰

