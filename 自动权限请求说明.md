# 🔐 自动权限请求功能说明

## ✨ 新功能：启动时自动申请权限

现在应用会在启动时**自动弹窗**请求必要权限，无需手动设置！

---

## 🚀 工作流程

### **应用启动后的自动流程：**

```
第1步：应用启动（0.5秒后）
   ↓
第2步：自动弹窗请求存储权限 📂
   ├─ 系统弹窗："允许HSR Automation访问存储？"
   ├─ 点击"允许" ✅
   └─ 存储权限已授予
   ↓
第3步：显示悬浮窗权限引导对话框 🔲
   ├─ 弹窗："需要悬浮窗权限"
   ├─ 点击"前往设置"
   ├─ 跳转到设置页面
   ├─ 开启权限
   └─ 返回应用
   ↓
第4步：显示无障碍服务引导对话框 ♿
   ├─ 弹窗："需要无障碍服务权限"（2秒后）
   ├─ 点击"前往设置"
   ├─ 跳转到无障碍设置
   ├─ 找到"HSR Automation"并开启
   └─ 返回应用
   ↓
第5步：权限设置完成 ✅
   └─ 状态显示："Ready - All permissions granted"
```

---

## 📱 **权限说明**

### **1. 存储权限（自动弹窗）** 📂

**请求方式**：Android系统原生弹窗

```
弹窗内容：
┌─────────────────────────────┐
│ 允许HSR Automation访问      │
│ 照片、媒体内容和文件？      │
│                             │
│  [拒绝]        [允许]       │
└─────────────────────────────┘
```

**操作**：点击"允许"

**用途**：
- 保存配置文件
- 保存日志
- 读取模板图片

---

### **2. 悬浮窗权限（引导对话框）** 🔲

**请求方式**：应用内对话框 → 跳转设置

```
对话框：
┌─────────────────────────────┐
│      需要悬浮窗权限         │
│                             │
│ 悬浮窗权限用于显示控制界面  │
│ 点击下方按钮前往设置        │
│                             │
│ 在设置中找到本应用并开启权限│
│                             │
│  [稍后]      [前往设置]     │
└─────────────────────────────┘
```

**操作流程**：
1. 点击"前往设置"
2. 自动跳转到系统设置
3. 找到"HSR Automation"
4. 开启"允许显示在其他应用的上层"
5. 返回应用

**用途**：
- 显示悬浮控制窗口（未来功能）
- 应用在其他应用之上显示界面

---

### **3. 无障碍服务（引导对话框）** ♿ **← 最重要！**

**请求方式**：应用内对话框 → 跳转设置（延迟2秒避免冲突）

```
对话框：
┌─────────────────────────────┐
│   需要无障碍服务权限        │
│                             │
│   这是最重要的权限！        │
│ 无障碍服务用于自动点击游戏  │
│ 点击下方按钮前往设置        │
│                             │
│ 在无障碍设置中找到          │
│ "HSR Automation"并开启      │
│                             │
│  [稍后]      [前往设置]     │
└─────────────────────────────┘
```

**操作流程**：
1. 点击"前往设置"（红色按钮强调）
2. 自动跳转到无障碍设置
3. 找到"HSR Automation"
4. 点击进入
5. 开启开关
6. 确认授权
7. 返回应用

**用途**：
- **模拟点击游戏界面** ← 核心功能
- 获取屏幕内容
- 自动化操作

---

## 🎯 **使用体验**

### **首次安装使用：**

```
1. 安装APK
   adb install hsrautomation.apk

2. 打开应用
   点击应用图标

3. 0.5秒后自动开始
   ↓
   
4. 弹窗1：存储权限
   → 点击"允许" ✅

5. 弹窗2：悬浮窗权限引导
   → 点击"前往设置"
   → 在设置中开启
   → 返回应用

6. 弹窗3：无障碍服务引导
   → 点击"前往设置"
   → 在无障碍设置中开启
   → 返回应用

7. 完成！开始使用 🎉
```

---

## 🔄 **权限检查和刷新**

### **手动检查权限：**

```
主界面 → 点击"Permissions"按钮

显示权限状态：
┌─────────────────────┐
│    权限设置         │
├─────────────────────┤
│ ✅ 存储权限         │
│ ✅ 悬浮窗权限       │
│ ✅ 无障碍服务       │
├─────────────────────┤
│ [开启悬浮窗权限]    │
│ [开启无障碍服务]    │
│ [🔄 刷新权限状态]   │
│ [关闭]              │
└─────────────────────┘
```

**功能**：
- 查看当前权限状态
- 手动跳转设置页面
- 刷新权限状态

---

## ⚙️ **技术实现**

### **代码架构：**

```python
# 新增模块
permission_manager.py
├─ PermissionManager 类
├─ request_all_permissions()      # 自动请求所有权限
├─ _request_storage_permission()  # 存储权限（系统弹窗）
├─ _show_overlay_permission_dialog()  # 悬浮窗引导
├─ _show_accessibility_dialog()   # 无障碍引导
├─ open_overlay_permission_settings()  # 跳转设置
└─ open_accessibility_settings()  # 跳转设置

# 更新模块
main.py
├─ init_permissions()  # 初始化权限管理器
├─ _auto_request_permissions()  # 自动请求（启动0.5秒后）
└─ _on_permissions_ready()  # 权限完成回调
```

### **关键时序：**

```
t=0s    应用启动
t=0.5s  开始权限请求
t=0.5s  弹出存储权限（系统弹窗）
t=用户操作后  存储权限回调
t=1.5s  显示悬浮窗引导（应用对话框）
t=3.5s  显示无障碍引导（应用对话框）
```

**设计考虑**：
- 延迟启动避免UI未加载
- 分步请求避免弹窗冲突
- 存储权限先行（系统弹窗优先）
- 悬浮窗和无障碍延迟显示

---

## 📋 **权限类型对比**

| 权限 | 请求方式 | 是否自动弹窗 | 重要性 |
|------|---------|-------------|--------|
| 存储 | 系统API | ✅ 是 | ⭐⭐⭐ |
| 悬浮窗 | 跳转设置 | ❌ 否（引导） | ⭐⭐ |
| 无障碍 | 跳转设置 | ❌ 否（引导） | ⭐⭐⭐⭐⭐ |
| 截图（MediaProjection） | 使用时请求 | ✅ 是 | ⭐⭐⭐⭐ |

---

## ❓ **常见问题**

### **Q1: 为什么无障碍服务不能自动弹窗？**

**A**: Android安全限制，无障碍服务必须用户手动到设置中开启，无法通过代码直接请求。

### **Q2: 点击"前往设置"后没反应？**

**A**: 
1. 检查是否已在设置页面（可能已跳转）
2. 某些手机需要手动找到"无障碍"设置
3. 重新打开应用重试

### **Q3: 存储权限弹窗没出现？**

**A**:
1. 可能已经授予（之前安装过）
2. 手动检查：设置 → 应用 → HSR Automation → 权限
3. 点击"Permissions"按钮查看状态

### **Q4: 能跳过权限请求吗？**

**A**: 
- 存储权限：可以点"拒绝"跳过（但影响功能）
- 悬浮窗/无障碍：可以点"稍后"跳过（但必须后续开启）
- 无障碍服务是**必须**的，否则无法自动点击

### **Q5: 如何重新请求权限？**

**A**:
```
方法1: 重启应用
→ 会再次自动请求

方法2: 点击"Permissions"按钮
→ 手动跳转设置
→ 点击相应按钮
```

---

## 🎁 **优势对比**

### **之前（手动）：**
```
❌ 用户不知道需要哪些权限
❌ 需要手动找设置页面
❌ 容易遗漏关键权限
❌ 使用前需要看说明文档
```

### **现在（自动）：**
```
✅ 启动后自动提示
✅ 一键跳转设置页面
✅ 逐步引导不遗漏
✅ 清晰的文字说明
✅ 权限状态可视化
```

---

## 🔒 **隐私说明**

### **权限使用承诺：**

```
✅ 存储权限：
   仅用于读写配置文件和日志
   不访问个人照片或文件

✅ 悬浮窗权限：
   仅用于显示控制界面
   不获取其他应用信息

✅ 无障碍服务：
   仅用于游戏自动化点击
   不记录其他应用操作
   不上传任何数据

⚠️ 本应用完全本地运行
   不联网，不上传数据
   所有操作在设备本地执行
```

---

## 📊 **测试清单**

### **验证权限请求功能：**

- [ ] 安装应用
- [ ] 启动应用
- [ ] 0.5秒后看到存储权限弹窗
- [ ] 点击"允许"
- [ ] 看到悬浮窗权限引导对话框
- [ ] 点击"前往设置"成功跳转
- [ ] 开启悬浮窗权限
- [ ] 返回应用
- [ ] 看到无障碍服务引导对话框
- [ ] 点击"前往设置"成功跳转
- [ ] 开启无障碍服务
- [ ] 返回应用
- [ ] 点击"Permissions"查看状态
- [ ] 所有权限显示✅
- [ ] 点击"Start"可以正常运行

---

## 🚀 **下一步**

### **权限设置完成后：**

```
1. 点击主界面"START"按钮
2. 立即切换到游戏
3. 应用开始自动化
4. 享受自动游戏！
```

---

**现在权限请求变得超级简单了！** 🎉

不再需要翻阅复杂的文档，启动应用就会自动引导你完成所有设置！

