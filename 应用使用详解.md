# 📱 HSR Automation 应用使用详解

## 🎨 应用界面（UI）介绍

### 📐 主界面布局

当你打开应用后，会看到这样的界面：

```
┌─────────────────────────────────┐
│     HSR Automation              │  ← 标题（蓝+橙+绿）
│        Assistant                │
│   > Ready                       │  ← 状态显示
├─────────────────────────────────┤
│  Options                        │  
│  ☑ Daily Commission             │  ← 复选框（勾选启用委托任务）
├─────────────────────────────────┤
│   ┌─────────┐  ┌─────────┐     │
│   │  START  │  │  STOP   │     │  ← 主要按钮
│   │ (绿色)  │  │ (红色)  │     │
│   └─────────┘  └─────────┘     │
├─────────────────────────────────┤
│   ┌──────────┐ ┌──────────┐    │
│   │Permissions│ │  About   │    │  ← 辅助按钮
│   │  (橙色)   │ │  (蓝色)  │    │
│   └──────────┘ └──────────┘    │
├─────────────────────────────────┤
│  Version 1.0 • Desktop Edition  │
│  ! For educational purposes only│
└─────────────────────────────────┘
```

### 🎨 界面元素说明

#### **1. 标题区域**
- **HSR Automation Assistant** - 应用名称
- **状态显示** - 显示当前状态：
  - `> Ready` - 就绪
  - `> Running...` - 运行中
  - `> Stopped` - 已停止
  - `> Error: xxx` - 错误信息

#### **2. 选项区域**
- **☑ Daily Commission** - 每日委托任务开关
  - 勾选 = 启用委托任务流程
  - 不勾选 = 仅执行基础任务

#### **3. 主要按钮**
- **START (绿色)** - 开始自动化
  - 点击后开始执行任务
  - 按钮变为灰色（禁用）
  - STOP按钮变为可用
  
- **STOP (红色)** - 停止自动化
  - 初始状态为禁用（灰色）
  - 运行时可点击停止
  - 点击后立即停止所有任务

#### **4. 辅助按钮**
- **Permissions (橙色)** - 权限管理
  - 查看所需权限
  - 跳转到权限设置
  
- **About (蓝色)** - 关于信息
  - 应用版本信息
  - 功能介绍

---

## ⚙️ **关于悬浮窗**

### 📌 **当前版本：无悬浮窗设计**

**重要说明**：
- ❌ 当前版本**没有**悬浮窗功能
- ✅ 应用以**全屏界面**方式运行
- ✅ 需要在应用界面点击START后，**切换到游戏**

### 🔄 **工作流程：**

```
1. 打开 HSR Automation 应用
   ↓
2. 勾选需要的任务（如 Daily Commission）
   ↓
3. 点击 START 按钮
   ↓
4. 立即按下 HOME键 或 多任务键
   ↓
5. 切换到游戏
   ↓
6. 自动化在后台运行，控制游戏
```

### 💡 **为什么没有悬浮窗？**

**技术原因**：
- 悬浮窗需要复杂的Android服务
- 当前版本专注于核心功能
- 后台运行更稳定

**替代方案**：
- 使用通知栏控制（未来版本）
- 或返回应用点击STOP

---

## 🎮 **如何与游戏联动**

### 🔗 **核心机制：无障碍服务 + 截图识别**

应用通过以下方式与游戏互动：

#### **1. 屏幕截图（MediaProjection）**
```
应用持续截取屏幕
    ↓
使用PIL进行图像识别
    ↓
查找游戏UI元素（按钮、图标等）
    ↓
获取坐标位置
```

#### **2. 模拟点击（Accessibility Service）**
```
找到目标按钮位置
    ↓
通过无障碍服务发送点击指令
    ↓
游戏响应点击
    ↓
执行下一步操作
```

### 📋 **完整联动流程示例**

#### **场景：自动执行每日委托**

```
步骤1: 检测登录界面
应用截图 → 查找 login_button_first.png → 找到 → 点击
                                    ↓ 未找到
                                 等待5秒 → 查找 game_start_screen.png 或 login_button.png → 点击

步骤2: 等待进入游戏
应用截图 → 查找 task.png → 找到 → 等待7秒 → 点击任务图标
                      ↓ 未找到
                   继续等待（无限循环）

步骤3: 执行委托任务
点击 task.png → 等待 → 查找 weituo.png → 在weituo区域查找 qianwang.png → 点击
                                                              ↓
                                                           等待2秒
                                                              ↓
                                              查找 paiqianzhong.png（派遣中）
                                              ↓                    ↓
                                          找到：点击close.png    未找到：继续
                                                              ↓
                                              点击 yijianlingqu.png（一键领取）
                                                              ↓
                                              等待2秒 → 点击 zaicipaiqian.png
                                                              ↓
                                              等待3秒 → 点击 close.png

步骤4: 继续其他任务...
```

### 🎯 **图像识别工作原理**

```python
# 伪代码演示
while 自动化运行:
    # 1. 截取当前屏幕
    screenshot = capture_screen()
    
    # 2. 加载模板图片（如 login_button.png）
    template = load_template('login_button.png')
    
    # 3. 在截图中查找模板
    position = find_image(screenshot, template, confidence=0.8)
    
    # 4. 如果找到，获取坐标
    if position:
        x, y = position
        
        # 5. 通过无障碍服务点击
        accessibility_service.click(x, y)
        
        # 6. 等待游戏响应
        wait(2秒)
```

---

## 📸 **需要准备的模板图片**

应用依赖这些模板图片来识别游戏界面：

### **登录相关**
- `login_button_first.png` - 首次登录按钮
- `login_button.png` - 标准登录按钮
- `game_start_screen.png` - 游戏开始界面

### **任务相关**
- `task.png` - 任务图标
- `weituo.png` - 委托区域
- `qianwang.png` - 前往按钮
- `paiqianzhong.png` - 派遣中标识
- `yijianlingqu.png` - 一键领取按钮
- `zaicipaiqian.png` - 再次派遣按钮
- `close.png` - 关闭按钮

### **挑战相关**
- `120kaituoli.png` - 120体力开拓力
- `jinru.png` - 进入按钮
- `jiahao.png` - 加号（添加）
- `tiaozhan.png` - 挑战按钮
- `kaishitiaozhan.png` - 开始挑战
- `beisukai.png` / `beisuguan.png` - 倍速开关
- `zidongkai.png` / `zidongguan.png` - 自动开关
- `zailaiyici.png` - 再来一次
- `tuichuguanqia.png` - 退出关卡

### **奖励相关**
- `lingqu.png` - 领取按钮
- `gift.png` - 礼物图标
- `400.png` / `500.png` - 体力值标识

---

## 🚀 **实际使用步骤**

### **准备阶段**

#### **1. 安装应用**
```bash
adb install hsrautomation-1.0-arm64-v8a-debug.apk
```

#### **2. 授予权限**

打开应用后：

**a. 点击 "Permissions" 按钮**
- 会显示所需权限列表
- 按提示操作

**b. 无障碍服务权限** ⭐ **最重要**
```
设置 → 无障碍 → HSR Automation → 启用
```
- **作用**: 允许应用模拟点击
- **必须启用，否则无法自动点击**

**c. 悬浮窗权限**
```
设置 → 应用 → HSR Automation → 悬浮窗权限 → 允许
```
- **作用**: 允许应用显示在其他应用之上
- **虽然当前版本无悬浮窗，但为未来功能准备**

**d. 存储权限**
```
应用启动时会自动请求
```
- **作用**: 保存日志和截图

**e. 截图权限（MediaProjection）**
```
首次使用时会弹出
```
- **点击 "立即开始"**
- **作用**: 允许应用截取屏幕内容
- **必须允许，否则无法识别游戏界面**

#### **3. 准备游戏**
- 确保游戏已安装
- 登录到角色选择界面或主界面

---

### **执行阶段**

#### **步骤1: 配置任务**
```
1. 打开 HSR Automation 应用
2. 勾选 "Daily Commission" （如果需要）
3. 状态显示：> Ready
```

#### **步骤2: 启动自动化**
```
1. 点击绿色 "START" 按钮
2. 状态变为：> Running...
3. START按钮变灰（禁用）
4. STOP按钮变为可用（红色）
```

#### **步骤3: 切换到游戏** ⭐ **关键**
```
立即操作：
1. 按下 HOME键 或 多任务键
2. 点击游戏图标（或从多任务切换）
3. 进入游戏界面
```

**⏰ 时间要求**：
- 启动后**尽快**切换（5秒内）
- 应用会开始截图和识别

#### **步骤4: 观察自动化**
```
游戏会自动：
1. 检测并点击登录按钮
2. 进入游戏主界面
3. 点击任务图标
4. 执行委托流程
5. 完成其他任务...
```

#### **步骤5: 停止（可选）**
```
方法A（推荐）：
1. 按多任务键
2. 切换回 HSR Automation 应用
3. 点击红色 "STOP" 按钮

方法B：
1. 直接关闭应用
2. 自动化会停止
```

---

## 🔍 **如何知道自动化在工作？**

### **正常运行的迹象**

✅ **游戏界面自动点击**
- 看到鼠标/点击效果
- 按钮被自动按下
- 界面自动切换

✅ **按照预期流程执行**
- 登录 → 任务 → 委托 → 挑战...

✅ **无需手动干预**
- 应用自动找到并点击目标

### **可能的问题**

❌ **没有任何反应**
- 检查无障碍服务是否启用
- 检查截图权限是否授予
- 查看应用状态是否为 "Running"

❌ **点击位置不准确**
- 模板图片可能与实际不匹配
- 需要重新截取模板
- 分辨率不同导致偏移

❌ **识别不到图标**
- 当前使用PIL识别，精度有限
- confidence值可能需要调整
- 游戏界面可能变化

---

## 📊 **运行状态说明**

### **状态显示含义**

| 状态 | 含义 | 说明 |
|------|------|------|
| `> Ready` | 就绪 | 可以开始 |
| `> Running...` | 运行中 | 正在执行任务 |
| `> Stopped` | 已停止 | 手动停止 |
| `> Checking login...` | 检查登录 | 登录流程 |
| `> Task detected` | 任务检测到 | 找到任务图标 |
| `> Executing commission` | 执行委托 | 委托流程 |
| `> Error: xxx` | 错误 | 出现问题 |

### **按钮状态**

| 按钮 | 颜色 | 状态 | 说明 |
|------|------|------|------|
| START | 绿色 | 可用 | 可以开始 |
| START | 灰色 | 禁用 | 已在运行 |
| STOP | 红色 | 可用 | 可以停止 |
| STOP | 灰色 | 禁用 | 未在运行 |

---

## 🎯 **完整使用场景示例**

### **场景：每天早上执行每日委托**

```
7:00 AM
├─ 手机解锁
├─ 打开 HSR Automation
├─ 确认 "Daily Commission" 已勾选
├─ 点击 "START"
├─ 立即切换到游戏（5秒内）
│
↓ [自动化开始]
│
├─ 7:01 应用检测登录界面，自动点击
├─ 7:02 进入游戏主界面
├─ 7:03 点击任务图标
├─ 7:04 执行委托流程
│    ├─ 点击委托
│    ├─ 检查是否已派遣
│    ├─ 一键领取奖励
│    └─ 再次派遣
├─ 7:10 完成所有任务
│
↓ [手动停止]
│
├─ 切回 HSR Automation
├─ 点击 "STOP"
└─ 完成！
```

---

## 🛠️ **调试技巧**

### **如何查看应用是否在工作？**

#### **方法1: 观察游戏**
- 看是否有自动点击
- 界面是否按预期切换

#### **方法2: 使用ADB日志**
```bash
# 连接手机
adb devices

# 查看应用日志
adb logcat | grep -i "python\|kivy\|hsr"

# 会看到类似输出：
# [INFO] Starting automation...
# [INFO] Checking for login button...
# [INFO] Found login_button at (500, 300)
# [INFO] Clicking at (500, 300)
```

#### **方法3: 检查权限状态**
```bash
# 检查无障碍服务
adb shell settings get secure enabled_accessibility_services

# 应该包含：
# com.hsr.automation.hsrautomation/.HSRAccessibilityService
```

---

## ⚠️ **注意事项**

### **重要提醒**

1. **必须授予所有权限**
   - 特别是无障碍服务和截图权限
   - 缺少任何一个都无法工作

2. **启动后立即切换到游戏**
   - 不要在应用界面停留
   - 应用需要看到游戏界面才能工作

3. **保持屏幕常亮**
   - 锁屏后自动化会暂停
   - 建议在开发者选项中启用 "充电时屏幕常亮"

4. **不要手动操作游戏**
   - 自动化运行时避免手动点击
   - 可能导致流程错乱

5. **图像识别限制**
   - 当前版本使用PIL，精度有限
   - 如果识别失败，可能需要调整模板图片

---

## 🔄 **未来改进计划**

### **计划中的功能**

1. **真正的悬浮窗控制**
   - 小窗口控制按钮
   - 可拖动位置
   - 实时状态显示

2. **更好的图像识别**
   - 添加NumPy支持
   - 提高识别精度
   - 支持多分辨率

3. **更灵活的任务配置**
   - 自定义任务流程
   - 可视化任务编辑器
   - 导入/导出配置

4. **通知栏控制**
   - 在通知栏显示状态
   - 快捷开关按钮
   - 进度提示

---

## 📞 **获取帮助**

**如果遇到问题**：

1. **查看日志**
   ```bash
   adb logcat | grep -i python
   ```

2. **检查权限**
   - 设置 → 应用 → HSR Automation → 权限

3. **重启应用**
   - 完全关闭后重新打开

4. **GitHub Issues**
   ```
   https://github.com/guojian123456789/hsr-automation/issues
   ```

---

## ✅ **快速检查清单**

**运行前检查**：
- [ ] 应用已安装
- [ ] 无障碍服务已启用
- [ ] 截图权限已授予
- [ ] 游戏已安装并登录
- [ ] 任务已勾选
- [ ] 点击START按钮
- [ ] 立即切换到游戏

**如果不工作**：
- [ ] 检查所有权限
- [ ] 查看ADB日志
- [ ] 重启应用
- [ ] 重新授权截图权限
- [ ] 确认无障碍服务启用

---

**祝使用愉快！** 🎮✨

