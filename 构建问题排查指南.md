# 🔧 构建问题排查指南

## 问题：双击bat文件后闪退

### 可能的原因

1. **Docker未安装**
2. **Docker未运行**
3. **脚本路径问题**
4. **权限问题**

---

## 🔍 诊断步骤

### 第一步：检查Docker环境

**双击运行**：`check_docker.bat`

这个脚本会检查：
- ✅ Docker是否安装
- ✅ Docker是否运行
- ✅ 必要文件是否存在

**预期输出**：
```
========================================
Docker环境检查工具
========================================

[1/4] 检查Docker是否安装...
Docker version 24.0.x, build xxxxx
[✓] Docker已安装

[2/4] 检查Docker是否运行...
[✓] Docker正在运行

[3/4] 检查Docker镜像...
[!] 未找到构建镜像（首次运行正常）

[4/4] 检查必要文件...
[✓] Dockerfile存在
[✓] buildozer.spec存在
[✓] main.py存在

========================================
环境检查完成！
========================================

[✓] 所有检查通过！可以开始构建。
```

---

## 🛠️ 解决方案

### 情况1：Docker未安装

**症状**：
```
[X] Docker未安装！
```

**解决方法**：

1. 下载Docker Desktop
   - 访问：https://www.docker.com/products/docker-desktop
   - 下载Windows版本

2. 安装Docker Desktop
   - 双击安装程序
   - 按照向导完成安装
   - 可能需要重启电脑

3. 启动Docker Desktop
   - 从开始菜单启动"Docker Desktop"
   - 等待启动完成（右下角图标变绿）

4. 重新运行 `check_docker.bat`

---

### 情况2：Docker未运行

**症状**：
```
[✓] Docker已安装
[X] Docker未运行！
```

**解决方法**：

1. 启动Docker Desktop
   - 从开始菜单打开"Docker Desktop"
   - 或点击桌面图标

2. 等待Docker完全启动
   - 观察右下角系统托盘
   - 鲸鱼图标应该是稳定的，不是旋转的
   - 鼠标悬停应显示"Docker Desktop is running"

3. 重新运行 `check_docker.bat`

**常见问题**：

- **WSL2未安装**：
  ```
  Docker Desktop requires Windows Subsystem for Linux 2
  ```
  解决：按照Docker提示安装WSL2

- **虚拟化未启用**：
  ```
  Hardware assisted virtualization is not enabled
  ```
  解决：在BIOS中启用虚拟化（VT-x/AMD-V）

---

### 情况3：必要文件缺失

**症状**：
```
[X] buildozer.spec不存在！
[X] main.py不存在！
```

**解决方法**：

1. 确认你在正确的目录
   ```bash
   # 应该看到这些文件
   dir
   ```
   应该包含：
   - main.py
   - buildozer.spec
   - automation_engine.py
   - image_processor.py
   - 等等

2. 如果在错误的目录
   ```bash
   cd D:\插件
   ```

3. 重新运行检查

---

## 🚀 使用改进的构建脚本

现在使用新的改进版脚本：

### 方法1：双击运行（推荐）

1. **双击**: `build_android_docker_fixed.bat`

2. **查看详细输出**
   - 窗口不会闪退
   - 会显示每一步的进度
   - 出错时会暂停并显示错误信息

### 方法2：命令行运行

```batch
# 打开PowerShell或CMD
cd D:\插件

# 运行改进的脚本
build_android_docker_fixed.bat

# 或指定构建类型
build_android_docker_fixed.bat debug
build_android_docker_fixed.bat release
build_android_docker_fixed.bat clean
```

---

## 📝 构建过程说明

### 正常的构建流程

```
========================================
HSR Automation - Docker构建工具
========================================

[检查] 正在检查Docker是否安装...
Docker version 24.0.x, build xxxxx
[成功] Docker已安装

[检查] 正在检查Docker是否运行...
[成功] Docker正在运行

[信息] 当前目录: D:\插件
[信息] 构建类型: debug

========================================
[步骤1/3] 构建Docker镜像
========================================

这可能需要几分钟时间，请耐心等待...

[成功] Docker镜像构建完成！

========================================
[步骤2/3] 开始构建APK（debug版本）
========================================

重要提示：
- 首次构建会下载Android SDK/NDK（约1-2GB）
- 预计需要30分钟到1小时
- 请确保网络连接稳定
- 请不要关闭此窗口

构建开始时间: 2025-10-06 xx:xx:xx

... (构建过程输出) ...

========================================
[步骤3/3] 查找生成的APK
========================================

[APK文件] D:\插件\bin\hsrautomation-1.0-arm64-v8a-debug.apk

========================================
[成功] 构建完成！
========================================
```

---

## 🐛 常见错误及解决

### 错误1：Docker镜像构建失败

**错误信息**：
```
[错误] Docker镜像构建失败！
```

**可能原因**：
- 网络连接问题
- 磁盘空间不足
- Docker配置问题

**解决方法**：

1. 检查网络连接
   ```bash
   ping google.com
   ```

2. 检查磁盘空间
   - 确保至少有5GB可用空间

3. 清理Docker
   ```bash
   docker system prune -a
   ```

4. 重启Docker Desktop

5. 重新运行构建

---

### 错误2：buildozer构建失败

**错误信息**：
```
[错误] 构建失败，错误代码: 1
```

**解决方法**：

1. 查看构建日志
   - 查找生成的日志文件：`build_log_*.txt`
   - 查找具体错误信息

2. 常见问题：
   - **Python版本问题**：确保buildozer.spec中的配置正确
   - **依赖问题**：检查requirements配置
   - **Java问题**：Docker镜像应该已包含正确的Java版本

3. 清理后重试
   ```bash
   build_android_docker_fixed.bat clean
   build_android_docker_fixed.bat debug
   ```

---

### 错误3：路径包含空格或中文

**症状**：
```
路径无效或Docker挂载失败
```

**解决方法**：

如果项目路径包含空格或中文（如`D:\插件`），可能导致问题。

**方法1**：移动到纯英文路径
```bash
# 移动项目到
D:\hsr-automation
```

**方法2**：修改脚本中的路径处理
```batch
REM 使用短路径
for %%i in ("%CURRENT_DIR%") do set SHORT_PATH=%%~si
```

---

## 📊 检查清单

构建前确认：

- [ ] Docker Desktop已安装
- [ ] Docker Desktop正在运行
- [ ] 在正确的项目目录（包含main.py）
- [ ] buildozer.spec文件存在
- [ ] 网络连接正常
- [ ] 磁盘空间充足（至少5GB）
- [ ] 使用改进的脚本：`build_android_docker_fixed.bat`

---

## 🎯 快速开始

```batch
# 1. 检查环境
check_docker.bat

# 2. 如果检查通过，开始构建
build_android_docker_fixed.bat

# 3. 等待完成（首次约30-60分钟）

# 4. 安装APK
adb install bin\hsrautomation-1.0-arm64-v8a-debug.apk
```

---

## 📞 获取帮助

如果仍然无法解决问题：

1. **查看日志文件**
   - `build_log_*.txt` - 构建日志
   - `.buildozer/android/platform/build-*/logs/` - 详细日志

2. **查看文档**
   - `BUILD_ANDROID_GUIDE.md` - 详细构建指南
   - `ANDROID_ADAPTATION_GUIDE.md` - Android适配指南

3. **检查Docker**
   ```bash
   docker info
   docker ps
   docker images
   ```

---

**更新日期**: 2025-10-06  
**版本**: 1.0




